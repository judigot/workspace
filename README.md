# Workspace Infrastructure

This repo keeps the nginx + workspace shell setup in one place so a fresh EC2 instance can be configured quickly.

## What this covers

- Nginx reverse proxy for:
  - `judigot.com` + `www.judigot.com`
  - `opencode.judigot.com`
  - `workspace.judigot.com`
  - Vite app slugs (e.g., `/playground`, `/new-app`)
- Workspace shell HTML (bubble UI + app iframe)
- Scripts to generate and deploy nginx config dynamically

## Quick start

1. Update DNS

Point the following to your EC2 public IP:

- `judigot.com`
- `www.judigot.com`
- `opencode.judigot.com`
- `workspace.judigot.com`

2. Generate + deploy nginx config

```bash
cd /home/ubuntu/workspace
./scripts/deploy-nginx.sh
```

3. Deploy the workspace shell

```bash
./scripts/deploy-workspace-shell.sh
```

4. Issue/expand TLS certs

```bash
sudo certbot --nginx -d judigot.com -d www.judigot.com -d opencode.judigot.com -d workspace.judigot.com
```

## Configuration

The nginx config is generated by `scripts/generate-nginx.sh` using environment variables.

### Common variables

- `DOMAIN` (default: `judigot.com`)
- `WWW_DOMAIN` (default: `www.${DOMAIN}`)
- `OPENCODE_SUBDOMAIN` (default: `opencode.${DOMAIN}`)
- `WORKSPACE_SUBDOMAIN` (default: `workspace.${DOMAIN}`)
- `SSL_CERT` (default: `/etc/letsencrypt/live/${DOMAIN}/fullchain.pem`)
- `SSL_KEY` (default: `/etc/letsencrypt/live/${DOMAIN}/privkey.pem`)
- `VITE_SCAFFOLDER_PORT` (default: `3000`)
- `API_BACKEND` (default: `127.0.0.1:5000`)
- `OPENCODE_BACKEND` (default: `127.0.0.1:4097`)
- `WORKSPACE_ROOT` (default: `/var/www/workspace`)

### Vite apps

Set a list of slug:port pairs:

```bash
export VITE_APPS="playground:5175 new-app:5176"
```

Each entry generates:

- `location /<slug>/__vite_hmr`
- `location /<slug>/`
- `upstream vite_<slug>`

## Workspace shell

The shell lives in `workspace-shell/index.html` and is deployed to `/var/www/workspace/index.html`.

Defaults:

- App iframe: `https://judigot.com/playground/`
- OpenCode iframe: `https://opencode.judigot.com/`

You can override the app URL at runtime:

```
https://workspace.judigot.com/?app=https://judigot.com/new-app/
```

## Notes

- The root path `/` proxies to OpenCode.
- Each Vite app slug adds CSP `frame-ancestors https://workspace.<domain>` so it can be embedded in the workspace shell.
